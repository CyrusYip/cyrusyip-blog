<script>
  function loadScript({
    url,
    delay,
    onloadCallback,
    async,
    preloadCallback,
    attributes = {},
  }) {
    function load() {
      if (preloadCallback) preloadCallback();

      const script = document.createElement("script");
      script.src = url;
      script.async = async;

      // Set attributes
      Object.entries(attributes).forEach(([key, value]) => {
        script.setAttribute(key, value);
      });

      if (onloadCallback) script.onload = onloadCallback;

      document.body.appendChild(script);
    }

    if (typeof delay !== "undefined") {
      setTimeout(load, delay);
    } else {
      load();
    }
  }


  // Google Analytics
  loadScript({
    url: "https://www.googletagmanager.com/gtag/js?id=G-8TSPGDFPRC",
    delay: 100,
    async: true,
    onloadCallback: function() {
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-8TSPGDFPRC");
      console.log("Google Analytics loaded")
    }
  })
</script>

{{/* Only load comment services for regular page */}}
{{ if .IsPage }}

<script>
// Check languages for comment services
let giscusLang, disqusLang;
if (document.documentElement.lang === "zh-CN") {
  giscusLang = "zh-CN";
  disqusLang = "zh";
} else {
  giscusLang = "en";
  disqusLang = "en";
}
// Giscus
loadScript({
  url: 'https://giscus.app/client.js',
  delay: 100,
  async: true,
  onloadCallback: () => console.log("Giscus loaded"),
  attributes: {
    'data-repo': 'CyrusYip/blog-comments',
    'data-repo-id': 'MDEwOlJlcG9zaXRvcnkzNDg2NjkxMTQ=',
    'data-category': 'Comments',
    'data-category-id': 'DIC_kwDOFMhEus4ChUiV',
    'data-mapping': 'pathname',
    'data-strict': '0',
    'data-reactions-enabled': '1',
    'data-emit-metadata': '0',
    'data-input-position': 'bottom',
    'data-theme': 'preferred_color_scheme',
    'data-lang': giscusLang,
    'data-loading': 'lazy',
    'crossorigin': 'anonymous'
  }
});

// Disqus
loadScript({
  url: "https://cyrusyip.disqus.com/embed.js",
  delay: 100,
  async: true,
  attributes: { "data-timestamp": +new Date() },
  preloadCallback: function() {
    window.disqus_config = function () {
      this.language = disqusLang;
    }
  },
  onloadCallback: function() { console.log("Disqus loaded") },
})
</script>

{{ end }}

<script>
  // swup head plugin
  loadScript({
    url: "https://unpkg.com/@swup/head-plugin@2",
    async: false,
    delay: 200,
    onloadCallback: function() {
      console.log("swup head plugin loaded");
      loadSwup();
    },
  })

  // swup preload plugin
  loadScript({
    url: "https://unpkg.com/@swup/preload-plugin@3",
    async: false,
    delay: 200,
    onloadCallback: function() {
      console.log("swup preload plugin loaded")
    }
  })
  // swup
  function loadSwup() {
    const script = document.createElement("script");
    script.src = "https://unpkg.com/swup@4";
    script.onload = () => {
      const swup = new Swup({
        plugins: [
          new SwupHeadPlugin(),
          new SwupPreloadPlugin({ preloadVisibleLinks: true }),
        ],
        animationSelector: false,
      });
      console.log("swup loaded");

      swup.hooks.on("page:view", () => {
        // Load comment services
        let giscusLang, disqusLang;
        if (document.documentElement.lang === "zh-CN") {
          giscusLang = "zh-CN";
          disqusLang = "zh";
        } else {
          giscusLang = "en";
          disqusLang = "en";
        }

        function loadGiscus() {
          const script = document.createElement('script');
          script.src = 'https://giscus.app/client.js';
          script.setAttribute('data-repo', 'CyrusYip/blog-comments');
          script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkzNDg2NjkxMTQ=');
          script.setAttribute('data-category', 'Comments');
          script.setAttribute('data-category-id', 'DIC_kwDOFMhEus4ChUiV');
          script.setAttribute('data-mapping', 'pathname');
          script.setAttribute('data-strict', '0');
          script.setAttribute('data-reactions-enabled', '1');
          script.setAttribute('data-emit-metadata', '0');
          script.setAttribute('data-input-position', 'bottom');
          script.setAttribute('data-theme', 'preferred_color_scheme');
          script.setAttribute('data-lang', giscusLang);
          script.setAttribute('data-loading', 'lazy');
          script.crossOrigin = 'anonymous';
          script.async = false;
          setTimeout(()=>{
            document.body.appendChild(script);
            console.log("Giscus loaded");
          }, 100)
        }
        const giscusElement = document.querySelector("div.giscus");
        // Only load Giscus if .giscus exists
        if (giscusElement) {
          loadGiscus();
        }

        function loadDisqus() {
          // Reload
          if (typeof DISQUS === 'object') {
            DISQUS.reset({
              reload: true,
              config: function() {
                this.page.url = window.location.href;
                this.language = disqusLang;
              }
            });
            DISQUS_RECOMMENDATIONS.reset();
            console.log("Disqus reloaded");
          } else {
            // Load
            window.disqus_config = function () {
              this.language = disqusLang;
            };
            const script = document.createElement("script");
            script.src = "https://cyrusyip.disqus.com/embed.js";
            script.setAttribute('data-timestamp', +new Date());
            document.body.appendChild(script);
            console.log("Disqus loaded")
          }
        }
        const disqusElement = document.querySelector("div#disqus_thread");
        if (disqusElement) {
          setTimeout(()=>{
            loadDisqus();
          }, 100)
        }
      })
    };
    script.async = false;
    document.body.appendChild(script);
  }
</script>